<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>pubsub.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AutoValues.html">AutoValues</a></li>
                                <li><a href="../classes/Collections.html">Collections</a></li>
                                <li><a href="../classes/PubSub.html">PubSub</a></li>
                                <li><a href="../classes/Schemas.html">Schemas</a></li>
                                <li><a href="../classes/Topic.html">Topic</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: pubsub.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Created with MakeItHappen.
 * User: lablancas
 * Date: 2015-03-21
 * Time: 02:58 PM
 * To change this template use Tools | Templates.
 */

 /** 
  * The Static Class containing the primary Publish/Subscribe functions and properties
  * 
  * @class PubSub
  * @static
  */ 
PubSub = {
    
    /**
     * Used to disable/enable debug logging output
     * 
     * @property debug {Boolean}
     */
    debug: false
};


/**
 * Creates a {{#crossLink &quot;Topic&quot;}}{{/crossLink}} Object 
 * 
 * @method createTopic
 * @param name {String} name to assign to the created {{#crossLink &quot;Topic&quot;}}{{/crossLink}}
 * @return {Topic} the created {{#crossLink &quot;Topic&quot;}}{{/crossLink}}
 * 
 */
PubSub.createTopic = function(name){
    return new Topic(name);
};

 /**
  * Returns the current, active subscribers
  * 
  * @method getActiveSubscribers
  * @param topic {Topic} [Optional] Used to filter Active Subscribers based on a {{#crossLink &quot;Topic&quot;}}{{/crossLink}}
  * @return &lt;a href=&quot;http://docs.meteor.com/#/full/mongo_cursor&quot;&gt;Mongo.Cursor&lt;/a&gt; A cursor object containing the Topic Subscribers of a {{#crossLink &quot;Topic&quot;}}{{/crossLink}} or all Topics
 */
PubSub.getActiveSubscribers = function(topic){
    check(topic, Match.Optional(Topic));
    
    var selector = {server:  Meteor.isServer, 
                    client:  Meteor.isClient, 
                    cordova: Meteor.isCordova, 
                    stoppedAt: {$exists: false}}
    
    if(Match.test(topic, Topic))
        selector.topic = topic.getName();
    
    return Collections.TopicSubscribers.find(selector);  
};

/**
  * Publish a message on a {{#crossLink &quot;Topic&quot;}}{{/crossLink}}
  * 
  * @method publish
  * @param topic {Topic} Used to define the Topic where you want to publish your message
  * @param messageBody {Object} The body of the message to publish. May not yet have an _id attribute, in which case Meteor will generate one for you.
  * @param callback {Function} [Optional] If present, called with an error object as the first argument and, if no error, the _id as the second.
  * @return {String} the unique ID assigned to your published message if successful
  * 
  * @throws {Error} an object containing the errors found when your message was validated
  * 
  */
PubSub.publish = function(topic, messageBody, callback){
    check(topic,       Topic);
    check(callback,    Match.Optional(Function) );


    var message = topic.createMessage(messageBody);
    
    PubSub.debug &amp;&amp; console.log(&quot;PubSub.publish -&gt; &quot; + JSON.stringify(message) );

    var validator = topic.validate(message);
    
    if(validator.isValid()){
        topic.getSchema().clean(message);
        return Collections.Messages.insert(message, callback);
    }
    else
        throw validator.getErrorObject(); 
};

/**
  * Creates a topic subscriber which calls the function defined by the caller. Returns a Subscriber Object.
  * 
  * @method subscribe
  * @param topic {Topic} Used to define the Topic where you want to subscribe for messages
  * @param fn {Function} Function to call when a message is created on this topic. Called with a userId as the first argument and the message as the second.
  * @param selector {Object} [Optional] A Mongo Selector used to check the contents of a message to determine if it should be passed to your Function
  * 
  * @return {Object} A Topic Subscriber Object
  */
PubSub.subscribe = function(topic, fn, selector){
    check(topic,        Topic);
    check(fn,           Function);
    check(selector,     Match.Optional(Object));

    var subscriber = {topic: topic.getName(), 
                      server: Meteor.isServer,
                      client: Meteor.isClient,
                      cordova: Meteor.isCordova
                     };
    
    if( Match.test(selector, Object) )
        subscriber.selector = JSON.stringify(selector);
    
    subscriber._id = Collections.TopicSubscribers.insert(subscriber);
    Collections.SubscriberFunctions[subscriber._id] = fn;

    /* This didn&#x27;t work
    SubscriberFunctions[subscriber._id] = function(userId, message){
        
        var validator = topic.validate(message)
        
        if(validator.isValid())
            fn(userId, message);
        
        else {
            PubSub.debug &amp;&amp; console.log( &quot;TopicSubscriber &quot; + JSON.stringify(subscriber) + &quot; receiving invalid message format &quot; + JSON.stringify(message) );
            PubSub.debug &amp;&amp; console.log( validator.getErrorObject() );
        }
    }
    */
    
    PubSub.debug &amp;&amp; console.log(&quot;PubSub.subscribe -&gt; &quot; + JSON.stringify(subscriber) );
    
    return subscriber;

};

/**
  * Removes a topic subscriber
  * 
  * @method unsubscribe
  * @param subscriber {Object} The object returned from calling {{#crossLink &quot;PubSub/subscribe:method&quot;}}{{/crossLink}}
  * 
  */
PubSub.unsubscribe = function(subscriber){
    check(subscriber,       Object);
    check(subscriber._id,   String);
    check(subscriber.topic, String);

    Collections.TopicSubscribers.update(subscriber._id, {$set: {stoppedAt: new Date()}});
    delete Collections.SubscriberFunctions[subscriber._id];
    
    PubSub.debug &amp;&amp; console.log(&quot;PubSub.unsubscribe -&gt; &quot; + JSON.stringify(subscriber) );
    
};

// clear old subscribers out
PubSub.getActiveSubscribers().forEach(PubSub.unsubscribe);


/**
 * Determines if a doc matches a selector.
 * 
 * @method matchesSelector
 * @param message {Object} The message document to check if it matches with the selector.
 * @param selector {Object} A Mongo Selector used to check the contents of the message to determine if the method is a match
 * 
 * @return {Boolean} true if the message is a match to the selector; otherwise, false
 */
PubSub.matchesSelector = function(message, selector){
    check(message,     Object);
    check(message._id, String);
    check(selector,    Match.Optional(Object));

    var s = {$and: [{_id: message._id}]}

    if( Match.test(selector, Object) )
        s.$and.push(selector);

    return Match.test( Collections.Messages.findOne(s), Object );
};


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
